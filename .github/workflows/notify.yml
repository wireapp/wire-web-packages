name: CI

on:
  push:
    branches:
      - master

jobs:
  send_notification:
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !contains(github.event.head_commit.message, '[skip ci]')

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{github.event.after}}
      - name: Setup environment variables
        run: |
          BRANCH_NAME="$(sed 's/refs\/heads\///g' <<< ${GITHUB_REF})"
          COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{github.event.after}})
          LAST_COMMITTER_NAME="$(git --no-pager show -s --format='%an' HEAD)"
          echo "::set-env name=BRANCH_NAME::${BRANCH_NAME}"
          echo "::set-env name=COMMIT_MESSAGE::${COMMIT_MESSAGE}"
          echo "::set-env name=GITHUB_REPOSITORY::${GITHUB_REPOSITORY}"
          echo "::set-env name=GITHUB_SHA::${GITHUB_SHA}"
          echo "::set-env name=LAST_COMMITTER_NAME::${LAST_COMMITTER_NAME}"
      - name: Send message
        uses: wireapp/github-action-wire-messenger@v1.0.0
        with:
          email: ${{secrets.WIRE_EMAIL}}
          password: ${{secrets.WIRE_PASSWORD}}
          conversation: ${{secrets.WIRE_CONVERSATION}}
          text: '${{env.LAST_COMMITTER_NAME}} pushed to [${{env.BRANCH_NAME}}](https://github.com/${{env.GITHUB_REPOSITORY}}/tree/${{env.BRANCH_NAME}}) ("[${{env.COMMIT_MESSAGE}}](https://github.com/${{env.GITHUB_REPOSITORY}}/commit/${{env.GITHUB_SHA}})"). Building packages ...'
